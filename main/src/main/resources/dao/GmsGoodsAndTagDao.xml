<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.dao.GmsGoodsAndTagDao">
    <resultMap id="GmsGoodsAndTagSearchResultMap" type="com.mall.entity.dto.GmsGoodsAndTagListResult"
               extends="com.mall.mbg.mapper.GmsGoodsMapper.BaseResultMap">
        <result column="tagCode" jdbcType="VARCHAR" property="tagCode"/>
        <result column="tagName" jdbcType="VARCHAR" property="tagName"/>
        <result column="tagType" jdbcType="VARCHAR" property="tagType"/>
    </resultMap>

    <!-- 批量取消商品标签绑定 -->
    <update id="cancelBind" parameterType="java.util.Map">
        <foreach collection="goodsAndTagList" separator=";" item="item">
            delete from gms_goods_and_tag where corp_no_=#{corpNo,jdbcType=VARCHAR}
            and goods_code_=#{item.goodsCode,jdbcType=VARCHAR}
            and tag_code_=#{item.tagCode,jdbcType=VARCHAR}
        </foreach>
    </update>

    <!-- 查询某个商品绑定了哪些标签 -->
    <select id="listTagByGoodsCode" resultType="com.mall.mbg.model.GmsTag">
        select tag.uid_,
               tag.corp_no_,
               tag.code_,
               tag.name_,
               tag.type_,
               tag.remark_,
               tag.app_user_,
               tag.app_date_,
               tag.update_user_,
               tag.update_date_
        from gms_goods_and_tag as gt
                 inner join gms_tag as tag on gt.corp_no_ = tag.corp_no_ and gt.tag_code_ = tag.code_
        where gt.corp_no_ = #{corpNo}
          and gt.goods_code_ = #{goodsCode}
    </select>

    <sql id="listGoodsAndTag">
        g.code_, g.brand_, g.class1_, g.class2_, g.class3_, g.desc_, g.spec_,
        tag.code_ as tagCode, tag.name_ as tagName, tag.type_ as tagType
    </sql>

    <!-- 模糊查询商品和料号的绑定关系 -->
    <select id="listGoodsAndTag" resultMap="GmsGoodsAndTagSearchResultMap">
        select
        <include refid="listGoodsAndTag"/>
        from gms_goods_and_tag as gt
        left join gms_goods as g on g.corp_no_ = gt.corp_no_ and g.code_ = gt.goods_code_
        left join gms_tag as tag on g.corp_no_ = tag.corp_no_ and gt.tag_code_ = tag.code_
        where g.corp_no_ = #{corpNo,jdbcType=VARCHAR}
        <if test="searchParam.goodsSearch != null and searchParam.goodsSearch !=''">
            and(
            g.code_ like concat('%',#{searchParam.goodsSearch,jdbcType=VARCHAR},'%')
            or g.desc_ like concat('%',#{searchParam.goodsSearch,jdbcType=VARCHAR},'%')
            or g.spec_ like concat('%',#{searchParam.goodsSearch,jdbcType=VARCHAR},'%')
            )
        </if>
        <if test="searchParam.tagSearch != null and searchParam.tagSearch !=''">
            and(
            tag.name_ like concat('%',#{searchParam.tagSearch,jdbcType=VARCHAR},'%')
            or tag.type_ like concat('%',#{searchParam.tagSearch,jdbcType=VARCHAR},'%')
            )
        </if>
        <if test="searchParam.maxRecord != null">
            limit #{searchParam.maxRecord}
        </if>
    </select>

</mapper>